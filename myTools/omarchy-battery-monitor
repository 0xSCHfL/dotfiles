#!/bin/bash

# Designed to be run by systemd timer every 30 seconds
# - Notify at 20%
# - Sleep at 10%

BATTERY_THRESHOLD=20
SLEEP_THRESHOLD=10

NOTIFICATION_FLAG="/run/user/$UID/omarchy_battery_notified"
SLEEP_FLAG="/run/user/$UID/omarchy_battery_slept"

BATTERY_LEVEL=$(omarchy-battery-remaining)
BATTERY_STATE=$(upower -i $(upower -e | grep 'BAT') | awk -F': ' '/state/ {print $2}')

send_notification() {
  notify-send -u critical "Û±êã Time to recharge!" \
    "Battery is down to ${1}%" \
    -i battery-caution -t 30000
}

if [[ -n "$BATTERY_LEVEL" && "$BATTERY_LEVEL" =~ ^[0-9]+$ ]]; then
  if [[ "$BATTERY_STATE" == "discharging" ]]; then

    # üîî Notify at 20%
    if [[ $BATTERY_LEVEL -le $BATTERY_THRESHOLD && ! -f $NOTIFICATION_FLAG ]]; then
      send_notification "$BATTERY_LEVEL"
      touch "$NOTIFICATION_FLAG"
    fi

    # üò¥ Sleep at 10%
    if [[ $BATTERY_LEVEL -le $SLEEP_THRESHOLD && ! -f $SLEEP_FLAG ]]; then
      touch "$SLEEP_FLAG"
      systemctl sleep
    fi

  else
    # Reset flags when charging or full
    rm -f "$NOTIFICATION_FLAG" "$SLEEP_FLAG"
  fi
fi
