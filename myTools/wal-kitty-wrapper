#!/bin/bash

# Custom wal wrapper that preserves kitty custom settings

WALLPAPER="$1"

# Remove cache to force regeneration
rm -rf ~/.cache/wal/schemes/* ~/.cache/wal/colors 2>/dev/null

# Generate new colors
wal -i "$WALLPAPER" -q

# Parse wal colors and directly set them using kitty remote control
# This bypasses config loading entirely
if [ -f ~/.cache/wal/colors-kitty.conf ]; then
    # Extract color settings and convert to kitty @ format
    grep -E "^(foreground|background|cursor|color[0-9])" ~/.cache/wal/colors-kitty.conf | while read line; do
        key=$(echo "$line" | cut -d' ' -f1)
        value=$(echo "$line" | cut -d' ' -f2)
        kitty @ set-colors "$key=$value" 2>/dev/null || true
    done
fi

# Force reload to apply changes
for pid in $(pgrep kitty); do
    kill -USR1 "$pid" 2>/dev/null || true
done